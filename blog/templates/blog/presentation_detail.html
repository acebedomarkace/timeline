{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ presentation.title }}</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/presentation_styles.css' %}">
</head>
<body>

<a href="{% url 'author_post_list' username=presentation.author.username %}" class="exit-link">&larr; Back to Timeline</a>

<div class="main-content">
    <div class="presentation-header">
        <h1>{{ presentation.title }}</h1>
        <p>By {{ presentation.author.username }} | Type: {{ presentation.get_type_display }}</p>
    </div>

    {% for post in all_posts %}
        <div class="slide article-container" id="post-{{ post.pk }}">
            <h2>{{ forloop.counter }}. {{ post.title }}</h2>
            
            {% if post.photo %}
                <figure>
                    <img src="{{ post.photo.url }}" alt="{{ post.title }}">
                    {% if post.photo_caption or post.media_description %}
                    <figcaption>
                        {% if post.photo_caption %}
                            <p>{{ post.photo_caption }}</p>
                        {% endif %}
                        {% if post.media_description %}
                            <p><em>{{ post.media_description }}</em></p>
                        {% endif %}
                    </figcaption>
                    {% endif %}
                </figure>
            {% endif %}

            <div class="post-content">
                {{ post.content|linebreaks }}
            </div>

            {% with embed_url=post.get_youtube_embed_url %}
                {% if embed_url %}
                    <figure>
                        <div class="video-container">
                            <iframe
                                src="{{ embed_url }}"
                                title="YouTube video player"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                referrerpolicy="strict-origin-when-cross-origin"
                                allowfullscreen>
                            </iframe>
                        </div>
                        {% if post.media_description %}
                        <figcaption>
                            <p><em>{{ post.media_description }}</em></p>
                        </figcaption>
                        {% endif %}
                    </figure>
                {% endif %}
            {% endwith %}

            {% if post.audio_file %}
                <figure>
                    <audio controls controlsList="nodownload" src="{{ post.audio_file.url }}"></audio>
                    {% if post.media_description %}
                    <figcaption>
                        <p><em>{{ post.media_description }}</em></p>
                    </figcaption>
                    {% endif %}
                </figure>
            {% endif %}

            {% if post.video_file %}
                <figure>
                    <div class="video-file-container">
                        <video controls controlsList="nodownload">
                            <source src="{{ post.video_file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                        </video>
                    </div>
                    {% if post.media_description %}
                    <figcaption>
                        <p><em>{{ post.media_description }}</em></p>
                    </figcaption>
                    {% endif %}
                </figure>
            {% endif %}
        </div>
    {% endfor %}
</div>

<div class="toc-pane">
    <h3>Table of Contents</h3>
    {% if all_posts %}
        {% regroup all_posts by subject as posts_by_subject %}
        <ul>
            {% for subject_group in posts_by_subject %}
                <li>
                    {% if subject_group.grouper %}
                        <h4 class="subject-heading">{{ subject_group.grouper.name }} ({{ subject_group.list|length }})</h4>
                    {% else %}
                        <h4 class="subject-heading">Uncategorized ({{ subject_group.list|length }})</h4>
                    {% endif %}
                    <ul class="post-list-toc">
                        {% for post in subject_group.list %}
                            <li><a href="#post-{{ post.pk }}">{{ post.title }}</a></li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>This presentation is empty.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            window.location.href = "{% url 'author_post_list' username=presentation.author.username %}";
        }
    });

    document.querySelectorAll('.subject-heading').forEach(heading => {
        heading.addEventListener('click', () => {
            heading.classList.toggle('collapsed');
            const postList = heading.nextElementSibling;
            postList.classList.toggle('collapsed');
        });
    });
</script>

</body>
</html>
