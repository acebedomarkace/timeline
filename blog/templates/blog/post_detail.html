{% extends "blog/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
<main class="article-container">
    <p>
        {% if user == post.author %}
            <a href="{% url 'author_post_list' username=user.username %}" class="back-link">&larr; Back to Your Timeline</a>
        {% else %}
            <a href="{% url 'public_timeline' %}" class="back-link">&larr; Back to Public Timeline</a>
        {% endif %}
        {% if user == post.author %}
            <a href="{% url 'request_peer_review' pk=post.pk %}" class="action-button">Request Peer Review</a>
        {% endif %}
    </p>
    <article class="post-card">
        {% if user == post.author %}
            <div class="status-indicator 
                {% if post.review_status == 'approved' %}status-approved
                {% elif post.review_status == 'revision_requested' %}status-revision-requested
                {% else %}status-draft{% endif %}">
                <strong>Status:</strong> {{ post.get_review_status_display }}
            </div>
        {% endif %}
        <h1 class="article-title">{{ post.title }}</h1>
        <div class="article-metadata">
            By 
            {% if user.is_authenticated %}
                <a href="{% url 'author_post_list' username=post.author.username %}">{{ post.author.username }}</a>
            {% else %}
                {{ post.author.username }}
            {% endif %}
            in {{ post.subject.name }} on {{ post.created_date|date:"F j, Y" }}
            <span>&bull; {{ post.view_count }} {% if post.view_count == 1 %}view{% else %}views{% endif %}</span>
        </div>

        <div class="article-body">
            {% if post.photo %}
                <figure>
                    <img src="{{ post.photo.url }}" alt="{{ post.title }}">
                    {% if post.photo_caption or post.media_description %}
                    <figcaption>
                        {% if post.photo_caption %}
                            <p>{{ post.photo_caption }}</p>
                        {% endif %}
                        {% if post.media_description %}
                            <p><em>{{ post.media_description }}</em></p>
                        {% endif %}
                    </figcaption>
                    {% endif %}
                </figure>
            {% endif %}

            <p>{{ post.content|linebreaksbr }}</p>

            {% with embed_url=post.get_youtube_embed_url %}
                {% if embed_url %}
                    <div class="video-container">
                        <iframe
                            src="{{ embed_url }}"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen>
                        </iframe>
                    </div>
                    {% if post.media_description %}
                        <p><em>{{ post.media_description }}</em></p>
                    {% endif %}
                {% endif %}
            {% endwith %}

            {% if post.audio_file %}
                <audio controls controlsList="nodownload" src="{{ post.audio_file.url }}"></audio>
                {% if post.media_description %}
                    <p><em>{{ post.media_description }}</em></p>
                {% endif %}
            {% endif %}

            {% if post.video_file %}
                <div class="video-file-container">
                    <video controls controlsList="nodownload">
                        <source src="{{ post.video_file.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    {% if post.media_description %}
                        <p><em>{{ post.media_description }}</em></p>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <div class="tags">
            {% for tag in post.tags.all %}
                {% if tag.name %}
                    {% if post.status == 'published' %}
                        <a href="{% url 'posts_by_tag' tag_name=tag.name %}" class="tag">{{ tag.name }}</a>
                    {% else %}
                        <span class="tag disabled">{{ tag.name }}</span>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </article>

    {% if user.is_authenticated and 'Teachers' in user.groups.all|join:", " %}
    <div class="teacher-actions">
        <h2>Teacher Actions</h2>
        <div class="teacher-actions-forms">
            <div class="teacher-actions-form-group">
                <h3>Update Status</h3>
                <form method="post">
                    {% csrf_token %}
                    {{ review_status_form.as_p }}
                    <button type="submit" name="status_submit" class="button-primary">Update Status</button>
                </form>
            </div>
            <div class="teacher-actions-form-group">
                <h3>Leave Private Feedback</h3>
                <form method="post">
                    {% csrf_token %}
                    {{ private_feedback_form.as_p }}
                    <button type="submit" name="feedback_submit" class="button-primary">Submit Feedback</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if private_feedback %}
    <div class="private-feedback-section">
        <h2>Private Feedback</h2>
        {% for feedback in private_feedback %}
            <div class="comment">
                <div class="comment-author-info">
                    <img src="{{ feedback.author.profile.image.url }}" class="feedback-author-img">
                    <div>
                        <strong>{{ feedback.author.username }}</strong>
                        <span class="teacher-badge">Teacher</span>
                        <div class="comment-date">{{ feedback.created_date|date:"F j, Y" }}</div>
                    </div>
                </div>
                <p>{{ feedback.text|linebreaksbr }}</p>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="comments-section">
        <h2>Public Feedback & Peer Review</h2>
        {% for comment in post.comments.all %}
            <div class="comment">
                <div class="comment-author-info">
                    <img src="{{ comment.author.profile.image.url }}" class="feedback-author-img">
                    <div>
                        <strong>{{ comment.author.username }}</strong>
                        {% if 'Teachers' in comment.author.groups.all|join:", " %}
                            <span class="teacher-badge">Teacher</span>
                        {% endif %}
                        <div class="comment-date">{{ comment.created_date|date:"F j, Y" }}</div>
                    </div>
                </div>
                <p>{{ comment.text|linebreaksbr }}</p>
            </div>
        {% empty %}
            <p>No public feedback has been given yet.</p>
        {% endfor %}

        {% if comment_form %}
            <hr>
            <h3>Leave Public Feedback</h3>
            <form method="post">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit" name="comment_submit" class="button-primary">Submit Comment</button>
            </form>
        {% endif %}
    </div>
</main>
{% endblock %}